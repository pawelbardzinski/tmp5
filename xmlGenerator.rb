@stuff = Hash.new{ |h,k| h[k] = Hash.new(&h.default_proc) }
@currencies = ["ARS","AUD","BRL","CAD","CHF","CNY","COP","EUR","GBP","HKD","IDR","INR","JPY","KWD","MXN","MYR","NZD","PEN","PHP","RUR","SEK","SGD","TRY","USD","VUV","ZAR","AED","BHD","CZK","DJF","DZD","EGP","IQD","JOD","LBP","LYD","MAD","MRO","OMR","PLN","QAR","SAR","SDG","SOS","SYP","TND","YER",'gldslv','gldplt','gldpld']
@time = ["00:00","00:02","00:04","00:06","00:08","00:10","00:12","00:14","00:16","00:18","00:20","00:22","00:24","00:26","00:28","00:30","00:32","00:34","00:36","00:38","00:40","00:42","00:44","00:46","00:48","00:50","00:52","00:54","00:56","00:58","01:00","01:02","01:04","01:06","01:08","01:10","01:12","01:14","01:16","01:18","01:20","01:22","01:24","01:26","01:28","01:30","01:32","01:34","01:36","01:38","01:40","01:42","01:44","01:46","01:48","01:50","01:52","01:54","01:56","01:58","02:00","02:02","02:04","02:06","02:08","02:10","02:12","02:14","02:16","02:18","02:20","02:22","02:24","02:26","02:28","02:30","02:32","02:34","02:36","02:38","02:40","02:42","02:44","02:46","02:48","02:50","02:52","02:54","02:56","02:58","03:00","03:02","03:04","03:06","03:08","03:10","03:12","03:14","03:16","03:18","03:20","03:22","03:24","03:26","03:28","03:30","03:32","03:34","03:36","03:38","03:40","03:42","03:44","03:46","03:48","03:50","03:52","03:54","03:56","03:58","04:00","04:02","04:04","04:06","04:08","04:10","04:12","04:14","04:16","04:18","04:20","04:22","04:24","04:26","04:28","04:30","04:32","04:34","04:36","04:38","04:40","04:42","04:44","04:46","04:48","04:50","04:52","04:54","04:56","04:58","05:00","05:02","05:04","05:06","05:08","05:10","05:12","05:14","05:16","05:18","05:20","05:22","05:24","05:26","05:28","05:30","05:32","05:34","05:36","05:38","05:40","05:42","05:44","05:46","05:48","05:50","05:52","05:54","05:56","05:58","06:00","06:02","06:04","06:06","06:08","06:10","06:12","06:14","06:16","06:18","06:20","06:22","06:24","06:26","06:28","06:30","06:32","06:34","06:36","06:38","06:40","06:42","06:44","06:46","06:48","06:50","06:52","06:54","06:56","06:58","07:00","07:02","07:04","07:06","07:08","07:10","07:12","07:14","07:16","07:18","07:20","07:22","07:24","07:26","07:28","07:30","07:32","07:34","07:36","07:38","07:40","07:42","07:44","07:46","07:48","07:50","07:52","07:54","07:56","07:58","08:00","08:02","08:04","08:06","08:08","08:10","08:12","08:14","08:16","08:18","08:20","08:22","08:24","08:26","08:28","08:30","08:32","08:34","08:36","08:38","08:40","08:42","08:44","08:46","08:48","08:50","08:52","08:54","08:56","08:58","09:00","09:02","09:04","09:06","09:08","09:10","09:12","09:14","09:16","09:18","09:20","09:22","09:24","09:26","09:28","09:30","09:32","09:34","09:36","09:38","09:40","09:42","09:44","09:46","09:48","09:50","09:52","09:54","09:56","09:58","10:00","10:02","10:04","10:06","10:08","10:10","10:12","10:14","10:16","10:18","10:20","10:22","10:24","10:26","10:28","10:30","10:32","10:34","10:36","10:38","10:40","10:42","10:44","10:46","10:48","10:50","10:52","10:54","10:56","10:58","11:00","11:02","11:04","11:06","11:08","11:10","11:12","11:14","11:16","11:18","11:20","11:22","11:24","11:26","11:28","11:30","11:32","11:34","11:36","11:38","11:40","11:42","11:44","11:46","11:48","11:50","11:52","11:54","11:56","11:58","12:00","12:02","12:04","12:06","12:08","12:10","12:12","12:14","12:16","12:18","12:20","12:22","12:24","12:26","12:28","12:30","12:32","12:34","12:36","12:38","12:40","12:42","12:44","12:46","12:48","12:50","12:52","12:54","12:56","12:58","13:00","13:02","13:04","13:06","13:08","13:10","13:12","13:14","13:16","13:18","13:20","13:22","13:24","13:26","13:28","13:30","13:32","13:34","13:36","13:38","13:40","13:42","13:44","13:46","13:48","13:50","13:52","13:54","13:56","13:58","14:00","14:02","14:04","14:06","14:08","14:10","14:12","14:14","14:16","14:18","14:20","14:22","14:24","14:26","14:28","14:30","14:32","14:34","14:36","14:38","14:40","14:42","14:44","14:46","14:48","14:50","14:52","14:54","14:56","14:58","15:00","15:02","15:04","15:06","15:08","15:10","15:12","15:14","15:16","15:18","15:20","15:22","15:24","15:26","15:28","15:30","15:32","15:34","15:36","15:38","15:40","15:42","15:44","15:46","15:48","15:50","15:52","15:54","15:56","15:58","16:00","16:02","16:04","16:06","16:08","16:10","16:12","16:14","16:16","16:18","16:20","16:22","16:24","16:26","16:28","16:30","16:32","16:34","16:36","16:38","16:40","16:42","16:44","16:46","16:48","16:50","16:52","16:54","16:56","16:58","17:00","17:02","17:04","17:06","17:08","17:10","17:12","17:14","17:16","17:18","17:20","17:22","17:24","17:26","17:28","17:30","17:32","17:34","17:36","17:38","17:40","17:42","17:44","17:46","17:48","17:50","17:52","17:54","17:56","17:58","18:00","18:02","18:04","18:06","18:08","18:10","18:12","18:14","18:16","18:18","18:20","18:22","18:24","18:26","18:28","18:30","18:32","18:34","18:36","18:38","18:40","18:42","18:44","18:46","18:48","18:50","18:52","18:54","18:56","18:58","19:00","19:02","19:04","19:06","19:08","19:10","19:12","19:14","19:16","19:18","19:20","19:22","19:24","19:26","19:28","19:30","19:32","19:34","19:36","19:38","19:40","19:42","19:44","19:46","19:48","19:50","19:52","19:54","19:56","19:58","20:00","20:02","20:04","20:06","20:08","20:10","20:12","20:14","20:16","20:18","20:20","20:22","20:24","20:26","20:28","20:30","20:32","20:34","20:36","20:38","20:40","20:42","20:44","20:46","20:48","20:50","20:52","20:54","20:56","20:58","21:00","21:02","21:04","21:06","21:08","21:10","21:12","21:14","21:16","21:18","21:20","21:22","21:24","21:26","21:28","21:30","21:32","21:34","21:36","21:38","21:40","21:42","21:44","21:46","21:48","21:50","21:52","21:54","21:56","21:58","22:00","22:02","22:04","22:06","22:08","22:10","22:12","22:14","22:16","22:18","22:20","22:22","22:24","22:26","22:28","22:30","22:32","22:34","22:36","22:38","22:40","22:42","22:44","22:46","22:48","22:50","22:52","22:54","22:56","22:58","23:00","23:02","23:04","23:06","23:08","23:10","23:12","23:14","23:16","23:18","23:20","23:22","23:24","23:26","23:28","23:30","23:32","23:34","23:36","23:38","23:40","23:42","23:44","23:46","23:48","23:50","23:52","23:54","23:56","23:58"]

if !File.exists?("/tmp5/data3.csv")
  @currencies.each do |currency|
    @time.each do |t|
      @stuff[currency][t] = '"","",""'
    end
  end
else
  data = File.open("/tmp5/data3.csv","r").read.to_s.split("\n")
  @cur = ''
  @tim = ''
  @text = ''
  data.each do |line|
    if line =~ /^[A-Za-z]/ && (line.length == 6 || line.length == 3) 
      line =~ /(\w+)/
      @cur = $1
    elsif line =~ /(\d+)\:(\d+)\,(.+)/
      @tim = $1+':'+$2
      @text = $3.to_s
    end
    @stuff[@cur][@tim] = @text
  end
end

=begin
@currencies.each do |currency|
  puts currency
  @time.each do |t|
    puts t+','+@stuff[currency][t].to_s
  end
end
=end

tn = Time.now
m = tn.min.to_s 
m = '0'+tn.min.to_s if tn.min.to_s.size == 1
h = tn.hour.to_s 
h = '0'+tn.hour.to_s if tn.hour.to_s.size == 1
time = h+':'+m
if time == '00:00'
  @currencies.each do |currency|
    @time.each do |t|
      arr = @stuff[currency][t].split(',')
      @stuff[currency][t] = '"",'+"#{arr[0].to_s},"+"#{arr[1].to_s}"
    end
  end
end

file_slv = File.open('/tmp5/raw_slv.htm','r').read.to_s 
file_slv =~ /\"USD\"\>(.+?)\<\/Price\>/
@slv_price = ($1.to_f*31.1034768).round(2).to_s
file_plt = File.open('/tmp5/raw_plt.htm','r').read.to_s 
file_plt =~ /\"USD\"\>(.+?)\<\/Price\>/
@plt_price = ($1.to_f*31.1034768).round(2).to_s
file_pld = File.open('/tmp5/raw_pld.htm','r').read.to_s 
file_pld =~ /\"USD\"\>(.+?)\<\/Price\>/
@pld_price = ($1.to_f*31.1034768).round(2).to_s
file = File.open('/tmp5/raw_gld.htm','r').read.to_s 
file =~ /\"USD\"\>(.+?)\<\/Price\>/
@gld_price_usd = ($1.to_f*31.1034768).round(2).to_s

@currencies.each do |currency|
  arr = @stuff[currency][time].to_s.split(',')
  currency = 'RUB' if currency == 'RUR'
  file =~ /\"#{currency}\"\>(.+?)\<\/Price\>/
  currency = 'RUR' if currency == 'RUB'
  @gld_price = ($1.to_f*31.1034768).round(2).to_s
  if currency == 'gldslv' 
    @stuff[currency][time] = (@gld_price_usd.to_f/@slv_price.to_f).round(2).to_s+','+arr[1].to_s+','+arr[2].to_s
  end
  if currency == 'gldplt' 
    @stuff[currency][time] = (@gld_price_usd.to_f/@plt_price.to_f).round(3).to_s+','+arr[1].to_s+','+arr[2].to_s
  end
  if currency == 'gldpld' 
    @stuff[currency][time] = (@gld_price_usd.to_f/@pld_price.to_f).round(2).to_s+','+arr[1].to_s+','+arr[2].to_s
  end
  if currency != 'gldslv' && currency != 'gldplt' && currency != 'gldpld'  
  @stuff[currency][time] = @gld_price+','+arr[1].to_s+','+arr[2].to_s
  end  
end

File.open('/tmp5/data3.csv','w') do |f|
  @currencies.each do |currency|
    f.puts currency
    @time.each do |t|
      f.puts t+','+@stuff[currency][t]
    end
  end
  ct = Time.now
  @weekend = 'weekday'
  @weekend = 'weekend' if ct.saturday? || (ct.sunday? && ct.hour < 18) || (ct.friday? && ct.hour >= 18)
  ttime = File.open('/tmp5/time.txt','r').read.to_s 
  (hr,mn) = ttime.split(':')
  @cline = (hr.to_i*30)+(mn.to_i/2)
  dates = File.open('/tmp5/date.txt','r').read.to_s
  @currencies.each do |currency|
    f.print ' 720'
  end
  f.puts 
  f.puts dates
  f.puts @cline
  f.print @weekend
end

File.open('/tmp5/latest_data3.csv','w') do |f|
  @currencies.each do |currency|
    f.puts time+','+@stuff[currency][time]
  end
  f.puts @cline
  f.print @weekend
end

system("zip /blazeds/tomcat/webapps/alive5/Alive6_HiRes/mobile/data.zip /tmp5/data3.csv")
system ("cp /tmp5/latest_data3.csv /blazeds/tomcat/webapps/alive5/Alive6_HiRes/mobile/latest_data.csv")
